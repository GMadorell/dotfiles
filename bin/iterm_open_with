#!/usr/bin/python
"""
Iterm is supposed to call this script when a click on a path of a file happens.

This can be configured inside iterm in:
    Settings/Profiles/Advanced/Semantic History

Expected call is like:
    /Users/YOUR:USER/bin/iterm_open_with \1 \2 \3 \4 \5
"""
import sys
import subprocess
from subprocess import Popen, PIPE, STDOUT
import datetime

PHPSTORM_EXTENSIONS = ["php", "feature"]
INTELLIJ_IDEA_EXTENSIONS = ["scala", "java", "clj"]
VIDEO_EXTENSIONS = ["mkv", "mp4", "avi"]

with open("/var/log/iterm_open_with.log", "a+") as log_file:
    log_file.write(
        "\n>>>> New execution - {0}\n".format(datetime.datetime.now()))

    args = sys.argv[1:]

    log_file.write("\nArgs - {0}\n".format(args))

    if (len(args) == 5):
        filename = args[0]
        line_number = args[1]
        text_before_click = args[2]
        text_after_click = args[3]
        pwd = args[4]
    elif len(args) == 4:
        filename = args[0]
        line_number = None
        text_before_click = args[1]
        text_after_click = args[2]
        pwd = args[3]
    else:
        log_file.write("ERROR - Cannot match arguments\n")

    log_file.write(
        "Extracted variables:\nfilename: {0}\nline_number: {1}\ntext_before_click: {2}\ntext_after_click: {3}\npwd: {4}\n".format(
            filename, line_number, text_before_click, text_after_click, pwd)
    )

    extension = filename.split(".")[-1]

    log_file.write("Extension detected: {0}\n".format(extension))

    if extension in PHPSTORM_EXTENSIONS:
        cmd = ["/usr/local/bin/jetbrains/idea", filename]
    elif extension in INTELLIJ_IDEA_EXTENSIONS:
        if line_number == None:
            cmd = ["/usr/local/bin/jetbrains/idea", filename]
        else:
            cmd = ["/usr/local/bin/jetbrains/idea", "--line", line_number, filename]

    elif extension in VIDEO_EXTENSIONS:
        cmd = ["/usr/local/bin/vlc", filename]
    else:
        cmd = ["/usr/local/bin/code", filename]

    log_file.write("Executing cmd: {0}".format(cmd))
    p = Popen(cmd, shell=False, stdin=PIPE, stdout=PIPE,
              stderr=STDOUT, close_fds=True)
    output = p.stdout.read()
    log_file.write(str(output))
